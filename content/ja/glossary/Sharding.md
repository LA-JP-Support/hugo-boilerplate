---
title: シャーディング
date: 2025-11-25
translationKey: sharding
description: シャーディングは、大規模な論理データセットを独立した小さな断片(シャード)に分割するデータベースアーキテクチャパターンであり、水平スケーリングとパフォーマンスの向上を可能にします。
keywords:
- シャーディング
- データベーススケーリング
- 水平パーティショニング
- シャードキー
- システム設計
category: AI Infrastructure & Deployment
type: glossary
draft: false
e-title: Sharding
term: しゃーでぃんぐ
reading: シャーディング
kana_head: か
---
## Shardingとは?

Shardingは、単一の大規模な論理データセットを**シャード**と呼ばれる小さな独立した断片に分割するデータベースアーキテクチャパターンです。各シャードはデータのサブセットを含む完全に機能するデータベースであり、すべてのシャードが合わさって全体のデータセットを構成します。各シャードは元のデータベースと同じスキーマを維持しますが、データの一部のみを格納します。通常、これはシャードキーによって決定されます。

**垂直パーティショニング**(列によるデータ分割)とは異なり、Shardingは**水平パーティショニング**の一形態です。行によってデータを分割し、異なるレコードを異なるデータベースに分散します。これにより**水平スケーリング**(スケールアウト)が可能になり、単一のより強力なサーバー(垂直スケーリング)に依存するのではなく、より多くのノードを追加することで増加する負荷に対応できます。

**例:**  
数百万人のユーザーを持つソーシャルメディアアプリケーションは、ユーザーIDによってユーザーテーブルをシャーディングし、ID 1〜1,000,000のユーザーをシャード1に、1,000,001〜2,000,000をシャード2に配置するなどの方法を取ることができます。各シャードは独立したデータベースであり、独自のサーバーまたはクラスター上で実行される可能性があります。

> 入門的な概要については、[GeeksforGeeks: Database Sharding – System Design](https://www.geeksforgeeks.org/system-design/database-sharding-a-system-design-concept/)を参照してください。

## 主要な概念と用語

- **シャード:** データの明確なサブセットを保持する個別のデータベースまたはパーティション。各シャードは元のデータベースと同じスキーマを持ちます。
- **シャードキー:** データレコードがどのシャードに属するかを決定するために使用されるデータベースフィールドまたは属性。シャードキーの選択は、バランスの取れた分散とパフォーマンスにとって重要です。
- **水平パーティショニング:** テーブルの行を複数のデータベース(シャード)に分散すること。
- **垂直パーティショニング:** テーブルの列を別々のテーブルまたはデータベースに分散すること。(例えば、使用頻度の低い列を別のテーブルに分離する)
- **シェアードナッシングアーキテクチャ:** 各シャードが完全に独立して動作し、ハードウェア、ストレージ、状態を共有しない。

**参考資料:**  
- [Hello Interview: Sharding in System Design](https://www.hellointerview.com/learn/system-design/core-concepts/sharding)  
- [Microsoft Learn: Sharding Pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/sharding)

## Shardingはどのように使用されるか?

Shardingは、スケーラブルで高性能、かつ耐障害性のあるシステムを設計するための基本です。以下の目的で使用されます:

- **水平スケーリング:** より多くのデータベースノードを追加することで容量を増やし、上限がない。
- **パフォーマンスの向上:** 各ノードが管理するデータ量を制限することで、クエリと書き込みの[レイテンシ](/en/glossary/latency/)を削減。
- **障害分離の向上:** 1つのシャードが障害を起こしても、他のシャードは影響を受けず、障害の影響範囲を封じ込める。
- **地理的最適化:** コンプライアンス、パフォーマンス、またはレイテンシのニーズに応じて、異なる地域にシャードを配置。

Shardingは2つのレベルで処理できます:

1. **アプリケーションレベルのSharding:** アプリケーションロジックが各操作のシャードを決定。柔軟性がありますが、複雑さが増します。
2. **データベースレベルのSharding:** データベース管理システム(DBMS)がネイティブにShardingをサポートし、ルーティングとストレージを内部で処理。

> 実践的な実装ガイダンスについては、[DigitalOcean: Understanding Database Sharding](https://www.digitalocean.com/community/tutorials/understanding-database-sharding)を参照してください。

## Sharding vs. パーティショニング

- **パーティショニング**は、データをセグメントに分割する広範な概念で、多くの場合、単一のデータベースインスタンス内で行われます。
- **Sharding**は特に水平パーティショニングを指しますが、異なるマシン上の別々の物理データベースにまたがります(シェアードナッシング)。
- **垂直パーティショニング**は列によってデータを分割し、**水平パーティショニング/Sharding**は行によって分割します。

パーティショニングは本質的に水平スケーラビリティを提供しません。通常、単一のマシン内に存在するためです。Shardingは、ストレージと計算の両方を複数のマシンに分散し、真のスケールアウトを可能にします。

> 違いの説明については、[Hello Interview: Partitioning vs Sharding](https://www.hellointerview.com/learn/system-design/core-concepts/sharding)を参照してください。

## なぜShardingを使用するのか?(動機と対処する問題)

### 単一ノードデータベースのスケーリング限界

- **ストレージ容量:** 各サーバーには有限のディスクとメモリの制限があります。
- **計算リソース:** 処理できる同時クエリ/書き込みの数には限界があります。
- **ネットワーク帯域幅:** ネットワークスループットがボトルネックになる可能性があります。
- **地理的制約:** すべてのデータを1つのサイトに保存すると、レイテンシと規制の問題が発生する可能性があります。

### 代替手段とその限界

- **垂直スケーリング:** サーバーハードウェアのアップグレード。物理的制約とコストによって制限されます。
- **レプリケーション:** 読み取りスケーリングとフェイルオーバーのためにデータを複製しますが、書き込みをスケールせず、一貫性の問題を引き起こす可能性があります。
- **キャッシング:** インメモリキャッシュ(例:Redis、Memcached)は読み取りを高速化しますが、ストレージや書き込みのスケーリングは解決しません。
- **パーティショニング:** 単一ノード内で管理性を向上させますが、スケールアウトはしません。

Shardingは、データとワークロードの両方を多くのマシンに分散することでこれらを克服し、真の水平スケーラビリティ、パフォーマンスの向上、障害の封じ込めを実現します。

> 詳細については、[GeeksforGeeks: Database Sharding – System Design](https://www.geeksforgeeks.org/system-design/database-sharding-a-system-design-concept/)を参照してください。

## Shardingの仕組み

1. **シャードキーを選択:**  
   各レコードのシャードを決定するために使用されるフィールド(例:ユーザーID、地域、日付)を選択します。シャードキーは安定していて、高いカーディナリティを持ち、均等に分散されている必要があります。
2. **データを分散:**  
   選択したSharding戦略(ハッシュ、範囲、ディレクトリなど)を使用して、シャードキーに基づいてデータをシャードに割り当てます。
3. **クエリと書き込みをルーティング:**  
   システム(アプリケーションコードまたはDBMS)が各操作を正しいシャードにルーティングします。

**実装オプション:**

- **アプリケーションレベルのSharding:** アプリケーション内のカスタムロジックでクエリと書き込みをルーティング。
- **データベースレベルのSharding:** データベースシステムがネイティブにShardingを処理。例:MongoDB、Cassandra、Sharding拡張機能を持つ一部のSQLデータベース。

**出典:**  
- [MongoDB: Database Sharding Explained](https://www.mongodb.com/resources/products/capabilities/database-sharding-explained)

## Sharding戦略とアーキテクチャ

Shardingに選択される方法は、データ分散、パフォーマンス、スケーラビリティ、運用の複雑さに影響します。

### 1. キーベース(ハッシュ)Sharding

- **仕組み:**  
  シャードキー(例:ユーザーID)にハッシュ関数を適用し、結果がターゲットシャードを決定します。例えば、`hash(user_id) mod N`(Nはシャード数)。
- **利点:**  
  - 均等なデータ分散(ハッシュ関数とキーが適切に選択されている場合)。
  - アルゴリズムによるルーティング。ルックアップテーブル不要。
- **欠点:**  
  - シャードの追加/削除にはリバランスが必要(多くのレコードを移動する必要がある)。
  - コンシステントハッシングで緩和可能。
- **例:**  
  3つのシャードの場合、キー123のレコードはシャード`hash(123) mod 3`に配置されます。

> 詳細:[GeeksforGeeks: Key-Based Sharding](https://www.geeksforgeeks.org/system-design/database-sharding-a-system-design-concept/)

### 2. 範囲ベースSharding

- **仕組み:**  
  シャードキーの連続した値範囲に基づいてデータをシャードに割り当てます。
- **利点:**  
  - 実装と理解が簡単。
  - 範囲クエリに効率的。
- **欠点:**  
  - 一部の範囲がはるかにアクティブな場合、不均等な分散(「ホットスポット」)。
- **例:**  
  ID 1〜1Mのユーザーをシャード1に、1M〜2Mをシャード2に配置など。

### 3. ディレクトリベースSharding

- **仕組み:**  
  各キー(または範囲)を特定のシャードにマッピングするルックアップテーブルを維持します。
- **利点:**  
  - 非常に柔軟。任意のマッピングをサポートし、リバランスが容易。
- **欠点:**  
  - ディレクトリが単一障害点およびパフォーマンスのボトルネックになる可能性があります。
- **例:**  
  アプリケーションがディレクトリサービスに、ユーザーID 1057を保持するシャードを問い合わせます。

### 4. 垂直Sharding

- **仕組み:**  
  列によってテーブルを分割し、異なる列(機能)を異なるマシンに配置します。
- **使用例:**  
  機能が独立してアクセスまたは更新される場合。
- **例:**  
  ソーシャルネットワークで、ユーザープロファイルを1つのシャードに、ユーザー投稿を別のシャードに配置。

**詳細説明:**  
- [GeeksforGeeks: Sharding Methods](https://www.geeksforgeeks.org/system-design/database-sharding-a-system-design-concept/)

## Shardingの利点

| 利点 | 説明 |
|------|------|
| 水平スケーリング | 必要に応じてより多くのノードを追加でき、上限がない |
| クエリパフォーマンス | 各クエリはサブセットのみにヒットし、レイテンシを削減 |
| 障害分離 | 停止/障害は影響を受けるシャードのみに影響 |
| コスト効率 | より安価なハードウェアでスケールアウト |
| 地理的最適化 | レイテンシ/コンプライアンスのためにユーザーの近くにデータを配置 |

- **水平スケーラビリティ:** より多くのシャードを追加することで容量を追加。
- **クエリパフォーマンスの向上:** シャードごとのデータセットが小さいため、クエリが高速化。
- **障害分離:** 1つのシャードの障害がシステム全体をダウンさせない。
- **コスト効率:** 単一の高価なサーバーをスケールアップする代わりに、コモディティハードウェアを使用可能。
- **地理的最適化:** パフォーマンスまたはコンプライアンスのために、ユーザーに近い場所にシャードを配置。

## 欠点と課題

- **実装と運用の複雑さ:** 複数のデータベース、ルーティング、バックアップ、監視、スキーマ変更の管理により複雑さが増加。
- **データホットスポット/不均等な分散:** シャードキーの選択が不適切だと、特定のシャードに過負荷がかかり、ボトルネックになる。
- **リバランス/リシャーディング:** シャード数の変更や歪みの修正には大量のデータ移動が必要で、多くの場合ダウンタイムやパフォーマンスへの影響がある。
- **クロスシャードクエリ:** 複数のシャードにまたがるクエリは遅く、調整が複雑。
- **一貫性と参照整合性:** シャード間で強い一貫性と外部キー制約を強制することが困難。
- **「一方通行のドア」:** シャーディングされたアーキテクチャからモノリシックなアーキテクチャに戻すことは困難。
- **限定的なデータベースサポート:** すべてのデータベースがネイティブにShardingをサポートしているわけではない。カスタムロジックまたはミドルウェアが必要な場合がある。

> 実際の課題については、[Medium: Understanding Sharding in System Design](https://medium.com/@hksrise/understanding-sharding-in-system-design-a-key-to-scalability-214ad71784c4)を参照してください。

## Shardingを使用すべき場合

### 適切なシナリオ

- データセットが単一ノードのストレージ、計算、またはネットワーク容量を超える。
- 書き込み/読み取りスループット要件が単一ノード(およびそのレプリカ)が処理できる範囲を超える。
- [マルチテナンシー](/en/glossary/multi-tenancy/)で、各テナントのデータを別々のシャードに分離できる。
- 特定の地域にデータを保存するための規制またはパフォーマンス要件。
- テナント、地域、またはデータドメインの独立したスケーリングが必要。

### 使用すべきでない場合

- 垂直スケーリングまたはレプリケーションで簡単に処理できる小〜中規模のデータセット。
- より単純な最適化(インデックス作成、クエリチューニング、キャッシング)で十分な場合。
- 運用オーバーヘッドと複雑さがスケーラビリティの利点を上回る場合。

**意思決定ガイダンス:**  
Shardingの前に、常に垂直スケーリング、レプリケーション、クエリ最適化を使い果たしてください。他のアプローチがスケーリングまたは分離のニーズに不十分な場合にのみShardingを行ってください。

## ベストプラクティスと考慮事項

- **適切なシャードキーを選択:**
  - 安定している(時間とともに変化しない)必要があります。
  - ホットスポットを避けるために均等に分散。
  - 最も一般的なクエリパターンに合わせる。
- **将来の成長とリシャーディングを計画:**
  - データ分散の変化を予測。シャードの追加/リバランスの容易さを設計。
- **クロスシャード操作を最小化:**
  - クロスシャード結合とトランザクションを最小化するようにクエリとスキーマを設計。
- **参照データをレプリケート:**
  - 静的または変化の遅いデータ(ルックアップテーブルなど)を各シャードに保存し、クロスシャードルックアップを回避。
- **操作を自動化:**
  - 監視、バックアップ、フェイルオーバー、バランシングに自動化を使用。
- **ホットスポットと歪みを監視:**
  - シャードごとの負荷を追跡。必要に応じてリバランス。
- **結果整合性を検討:**
  - 複数のシャードにまたがる操作では、強い一貫性よりも結果整合性モデルの方が実用的な場合があります。

> 運用のヒント:[GeeksforGeeks: Database Sharding – System Design](https://www.geeksforgeeks.org/system-design/database-sharding-a-system-design-concept/)

## 使用例

### 1. ソーシャルネットワーク

- **問題:** 数十億のユーザープロファイル、投稿、関係。高い読み取り/書き込みボリューム。
- **解決策:** ユーザーIDまたは地域によってユーザーデータをシャーディング。各シャードがユーザーのサブセットとそのコンテンツを管理。
- **利点:** ユーザーの成長に合わせてスケールし、障害を分離し、グローバル分散をサポート。

### 2. Eコマースプラットフォーム

- **問題:** 大規模な製品カタログと注文履歴。高い同時実行性。
- **解決策:** 注文IDの範囲または顧客地域によって注文データをシャーディング。カテゴリまたは価格帯によって製品データをシャーディング。
- **利点:** ワークロードを並列化し、クエリパフォーマンスを向上させ、地域規制をサポート。

### 3. SaaSアプリケーション(マルチテナンシー)

- **問題:** 各テナントが異なるデータと使用パターンを持つ。
- **解決策:** テナントIDによってテナントをシャードに割り当て(ルックアップまたはハッシュ戦略を使用)。
- **利点:** テナントデータを分離し、顧客ベースに合わせてスケールし、テナント固有のスケーリングをサポート。

### 4. AIインフラストラクチャ

- **問題:** トレーニング/推論用の大規模データセット。分散計算。
- **解決策:** データソース、時間範囲、またはデータタイプによってデータセットをシャーディング。計算ノードに分散。
- **利点:** 並列処理を可能にし、データアクセスを高速化し、モデルトレーニングとサービングのスケーラビリティを実現。

## 実践例

**書籍カタログWebサイト**

世界中の数百万冊の書籍をカタログ化し、大量のクエリトラフィックがあるサイトを運営しているとします。

- **シャードキー:** ISBNチェックディジット(0〜10)をシャードキーとして使用し、11の論理シャードを作成。
- **シャード割り当て:** 論理シャードを3つの物理データベースサーバーにマッピング。
- **ルーティング:** ルックアップテーブルがISBNチェックディジットからサーバーへのマッピングを保存。
- **結果:** 書籍レコードの均等な分散、スケーラブルなクエリスループット、障害分離。

## Shardingの代替手段

- **垂直スケーリング:** サーバーハードウェア(CPU、RAM、ディスク)をアップグレード。
- **レプリケーション:** 負荷分散と[高可用性](/en/glossary/high-availability--ha-/)のために読み取りレプリカを追加。
- **キャッシング:** インメモリキャッシュ(例:Redis、Memcached)を使用してデータベース負荷を削減。
- **パーティショニング:** 単一のデータベースノード内でテーブルを分割。
- **コンテンツ配信ネットワーク(CDN):** 静的/読み取り重視のデータをオフロード。

Shardingにコミットする前に、これらのオプションを検討してください。

## 参考資料/リファレンス

- [GeeksforGeeks: Database Sharding – System Design](https://www.geeksforgeeks.org/system-design/database-sharding-a-system-design-concept/)
- [Hello Interview: Sharding in System Design](https://www.hellointerview.com/learn/system-design/core-concepts/sharding)
- [Medium: Understanding Sharding in System Design](https://medium.com/@hksrise/understanding-sharding-in-system-design-a-key-to-scalability-214ad71784c4)
- [Microsoft Learn: Sharding pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/sharding)
- [MongoDB: Database Sharding Explained](https://www.mongodb.com/resources/products/capabilities/database-sharding-explained)
- [DigitalOcean: Understanding Database Sharding](https://www.digitalocean.com/community/tutorials/understanding-database-sharding)
- [Aerospike: What is Sharding?](https://aerospike.com/blog/what-is-sharding/)
- [YouTube: What is Database Sharding?](https://www.youtube.com/watch?v=hdxdhCpgYo8)

## 概要表:Shardingの概要

| 側面 | Sharding |
|------|----------|
| それは何か | 単一の論理データセットを複数の独立したデータベース(シャード)に分割 |
| どのように使用されるか | データベースを水平にスケールし、パフォーマンスを向上させ、障害を分離するため |
| 一般的な戦略 | キーベース(ハッシュ)、範囲ベース、ディレクトリベース、垂直(列/機能) |
| 利点 | スケーラビリティ、パフォーマンス、コスト効率、障害分離、地理的最適化 |
| 欠点 | 複雑さ、リバランスの課題、クロスシャードクエリ、運用オーバーヘッド、ホットスポット |
| 使用例 | ソーシャルネットワーク、SaaS/マルチテナントプラットフォーム、Eコマース、AI/MLデータパイプライン |
| 使用すべき場合 | データまたはトラフィックが単一ノード容量を超える場合、または分離/規制のニーズがある場合 |
| 避けるべき場合 | 垂直スケーリング/レプリケーション/キャッシングで十分な場合、または小〜中規模のデータセットの場合 |
| 主要なベストプラクティス | 安定した、均等に分散されたシャードキーを選択。成長を計画。クロスシャードクエリを最小化 |

## FAQ

**Q: Shardingはデータと負荷の均等な分散を保証しますか?**  
A: いいえ。それは完全にシャードキーとSharding戦略に依存します

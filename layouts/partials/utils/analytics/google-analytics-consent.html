{{/*
@component: Google Analytics Consent (Delayed Loading)
@description: Implements Google Analytics with cookie consent system and delayed loading for better LCP.
@params:
  - gaMeasurementID: Google Analytics measurement ID (from Site.Language.Params.gaMeasurementID or Site.Params.gaMeasurementID)
@usage:
  {{ partial "utils/analytics/google-analytics-consent.html" . }}
*/}}

{{/* Determine the appropriate Google Analytics ID */}}
{{ $analyticsID := "" }}

{{/* Get the measurement ID from the language params */}}
{{ with .Site.Language.Params.gaMeasurementID }}
  {{ $analyticsID = . }}
{{ end }}

{{/* Fallback to the site params if no language-specific ID is found */}}
{{ if not $analyticsID }}
  {{ $analyticsID = .Site.Params.gaMeasurementID | default "" }}
{{ end }}

{{/* Only proceed if we have a valid analytics ID */}}
{{ if $analyticsID }}
  <script>
    // Delayed Google Analytics loading for better LCP
    (function() {
      var gaLoaded = false;
      var gaID = '{{ $analyticsID }}';
      
      // Define consent update function early
      window.updateGoogleAnalyticsConsent = function(allowed) {
        if (typeof gtag === 'function') {
          gtag('consent', 'update', {
            'analytics_storage': allowed ? 'granted' : 'denied',
            'ad_storage': allowed ? 'granted' : 'denied',
            'ad_user_data': allowed ? 'granted' : 'denied',
            'ad_personalization': allowed ? 'granted' : 'denied'
          });
        }
      };
      
      // Helper function to get cookie value
      function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }
      
      function loadGoogleAnalytics() {
        if (gaLoaded) return;
        gaLoaded = true;
        
        // Initialize dataLayer
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        window.gtag = gtag;
        gtag('js', new Date());
        
        // Check for existing consent before setting defaults
        var consentStatus = getCookie('cookie_consent_status');
        
        if (consentStatus === 'all') {
          gtag('consent', 'default', {
            'analytics_storage': 'granted',
            'ad_storage': 'granted',
            'ad_user_data': 'granted',
            'ad_personalization': 'granted'
          });
        } else {
          gtag('consent', 'default', {
            'ad_storage': 'granted',
            'ad_user_data': 'granted',
            'ad_personalization': 'granted',
            'analytics_storage': 'granted',
            'functionality_storage': 'granted',
            'anonymize_ip': true
          });
          gtag('consent', 'default', {
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'analytics_storage': 'denied',
            'functionality_storage': 'denied',
            'region': ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE', 'IS', 'LI', 'NO']
          });
        }

        // Configure Google Analytics
        gtag('config', gaID, {
          'allow_google_signals': true,
          'allow_enhanced_conversions': true,
          'linker': {
            'domains': [
              {{- $domains := slice -}}
              {{- range site.Home.AllTranslations -}}
                {{- $url := .Permalink -}}
                {{- if $url -}}
                  {{- $domain := (urls.Parse $url).Host -}}
                  {{- if not (in $domains $domain) -}}
                    {{- $domains = $domains | append $domain -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
              {{- range $index, $domain := $domains -}}
                {{- if $index -}}, {{- end -}}
                "{{ $domain }}"
              {{- end -}}
            ]
          }
        });
        
        // Load gtag.js script
        var script = document.createElement('script');
        script.src = 'https://www.googletagmanager.com/gtag/js?id=' + gaID;
        script.async = true;
        document.head.appendChild(script);
      }
      
      // Delay loading: after 3 seconds OR on user interaction (whichever comes first)
      var loadTimeout = setTimeout(loadGoogleAnalytics, 3000);
      
      var userInteractionEvents = ['scroll', 'click', 'touchstart', 'mousemove', 'keydown'];
      function onUserInteraction() {
        clearTimeout(loadTimeout);
        loadGoogleAnalytics();
        userInteractionEvents.forEach(function(event) {
          window.removeEventListener(event, onUserInteraction, { passive: true });
        });
      }
      
      userInteractionEvents.forEach(function(event) {
        window.addEventListener(event, onUserInteraction, { passive: true, once: true });
      });
    })();
  </script>
{{ end }}

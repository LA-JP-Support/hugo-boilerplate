{{/*
@helper: Get Language URL
@description: Returns the URL for a given language code using precomputed translation URLs
@params:
  .code (string): The language code (e.g., "en", "de", "es")
  .langData (object): Language data object from all_languages.yaml
  .currentPage (Page): The current Hugo page object
  .filePath (string): The file path relative to content directory (optional)
  .permalink (string): Direct permalink override (optional)
@returns: The full URL for the specified language
*/}}

{{ $code := .code }}
{{ $langData := .langData }}
{{ $currentPage := .currentPage }}
{{ $filePath := .filePath }}
{{ $permalink := .permalink }}
{{ $currentLangCode := $currentPage.Language.Lang }}

{{ $href := "" }}

{{ if $langData }}
  {{/* Set up base domain */}}
  {{ $baseDomain := strings.TrimSuffix "/" site.BaseURL }}
  {{ if or (eq site.BaseURL "") (eq site.BaseURL "/") }}
    {{ $baseDomain = "" }}
  {{ end }}
  
  {{/* Default URL using language base URL */}}
  {{ $href = printf "%s/%s/" $baseDomain $code }}
  
  {{/* Try to load from precomputed translation URLs */}}
  {{ if $filePath }}
    {{/* Clean up file path - remove language prefix if present */}}
    {{ $cleanFilePath := $filePath }}
    {{ $langPrefix := printf "%s/" $currentLangCode }}
    {{ if hasPrefix $cleanFilePath $langPrefix }}
      {{ $cleanFilePath = strings.TrimPrefix $langPrefix $cleanFilePath }}
    {{ end }}
    
    {{/* Determine folder from file path */}}
    {{ $folder := "_root" }}
    {{ $pathParts := split $cleanFilePath "/" }}
    {{ if gt (len $pathParts) 1 }}
      {{ $folder = index $pathParts 0 }}
    {{ end }}
    
    {{/* Load translation URLs directly without partialCached to avoid issues */}}
    {{ $folderKey := replace $folder "-" "_" }}
    {{ $translationUrls := site.Data.translation_urls }}
    {{ if $translationUrls }}
      {{ $folderData := index $translationUrls $folderKey }}
      {{ if $folderData }}
        {{/* Get translation data for this specific file */}}
        {{ $translationData := index $folderData $cleanFilePath }}
        {{ if $translationData }}
          {{/* Get URL for the requested language */}}
          {{ $translatedUrl := index $translationData $code }}
          {{ if $translatedUrl }}
            {{/* Use the precomputed URL from JSON */}}
            {{/* For custom domains (baseURL="/"), remove language prefix from URL */}}
            {{ $cleanUrl := $translatedUrl }}
            {{ if not (hasPrefix $cleanUrl "/") }}
              {{ $cleanUrl = printf "/%s" $cleanUrl }}
            {{ end }}
            {{ if strings.Contains $cleanUrl "/glossary/" }}
              {{ $cleanUrl = strings.ToLower $cleanUrl }}
            {{ end }}
            {{ $href = printf "%s%s" $baseDomain $cleanUrl }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{/* If translation_urls didn't yield a URL, construct from current page path */}}
    {{ if not $href }}
      {{ $currentRel := $currentPage.RelPermalink }}
      {{ $currentPrefix := printf "/%s/" $currentLangCode }}
      {{ $rest := strings.TrimPrefix $currentPrefix $currentRel }}
      {{ $rest = strings.TrimPrefix "/" $rest }}
      {{ $constructed := printf "/%s/%s" $code $rest }}
      {{ if or (eq $rest "") (eq $rest "/") }}
        {{ $constructed = printf "/%s/" $code }}
      {{ end }}
      {{ if strings.Contains $constructed "/glossary/" }}
        {{ $constructed = strings.ToLower $constructed }}
      {{ end }}
      {{ $href = printf "%s%s" $baseDomain $constructed }}
    {{ end }}
  {{ end }}
{{ else if $permalink }}
  {{ $href = $permalink }}
{{ end }}

{{ return $href }}
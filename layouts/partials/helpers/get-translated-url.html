{{/*
@component: Get Translated URL
@description: Gets the properly translated URL for a page, using the custom URL from frontmatter if available
@params:
  - url: The base URL path (e.g., "/features/")
  - lang: The current language code (optional, defaults to site language)
@returns: The translated URL with language prefix
@example:
{{ $translatedUrl := partial "helpers/get-translated-url.html" (dict "url" "/features/") }}
*/}}

{{- $url := .url | default "#" -}}
{{- $lang := .lang | default site.Language.Lang -}}
{{- $site := site -}}
{{- $contextPage := .page | default false -}}

{{- /* Handle external URLs and anchors - return as-is */ -}}
{{- if or (hasPrefix $url "http://") (hasPrefix $url "https://") (hasPrefix $url "#") -}}
  {{- $url -}}
{{- else if hasPrefix $url "/" -}}
  {{- $trimmed := strings.TrimPrefix "/" $url -}}
  {{- $parts := split $trimmed "/" -}}
  {{- $first := index $parts 0 | default "" -}}
  {{- $knownLang := false -}}
  {{- range site.Languages -}}
    {{- if eq .Lang $first -}}
      {{- $knownLang = true -}}
    {{- end -}}
  {{- end -}}
  {{- if $knownLang -}}
    {{- $url -}}
  {{- else -}}
    {{- /* Try to find the page and get its actual URL from frontmatter */ -}}
    {{- $contentPath := strings.TrimPrefix "/" (strings.TrimSuffix "/" $url) -}}
    {{- $page := false -}}

    {{- /* First try to resolve relative references from the current page context */ -}}
    {{- if $contextPage -}}
      {{- with $contextPage.GetPage $contentPath -}}
        {{- $page = . -}}
      {{- end -}}
    {{- end -}}

    {{- /* First try to get the page directly in current language */ -}}
    {{- if not $page -}}
      {{- with $site.GetPage (printf "/%s/%s" $lang $contentPath) -}}
        {{- $page = . -}}
      {{- else -}}
        {{- /* Try without language prefix */ -}}
        {{- with $site.GetPage $contentPath -}}
          {{- $page = . -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- if $page -}}
      {{- /* Use the page's actual URL from frontmatter if it exists */ -}}
      {{- with $page.Params.url -}}
        {{- . | relLangURL -}}
      {{- else -}}
        {{- $page.RelPermalink -}}
      {{- end -}}
    {{- else -}}
      {{- /* Fallback to just adding language prefix */ -}}
      {{- $url | relLangURL -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{- /* Handle relative page references like "RAG.md" within the current section */ -}}
  {{- if $contextPage -}}
    {{- with $contextPage.GetPage $url -}}
      {{- .RelPermalink -}}
    {{- else -}}
      {{- $url -}}
    {{- end -}}
  {{- else -}}
    {{- $url -}}
  {{- end -}}
{{- end -}}
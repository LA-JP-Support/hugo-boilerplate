{{/* 
  Features partial with alternating sections
  
  Parameters:
  - backgroundColor: Background color class (default: "bg-white")
  - heading: Main heading text (default: "Protect your device")
  - description: Description text below the main heading (default: "As a digital creative, your laptop or tablet is at the center of your work. Keep your device safe with a fabric sleeve that matches in quality and looks.")
  - layoutSize: Layout ratio between content and image ("small-text" for current layout, "balanced" for 50/50, "wide-text" for wider text)
  - features: Array of feature objects with the following structure:
    - title: Feature title
    - description: Feature description
    - listItems: Optional array of list items for this feature
    - featureCards: Optional array of feature cards (2x2 grid) with icon, title, description, url
    - ctaText: Optional CTA button text for this feature
    - ctaUrl: Optional CTA button URL for this feature
    - ctaStyle: Optional CTA button style class (default: "bg-primary hover:bg-primary-dark text-white")
    - ctaTarget: Optional CTA button target attribute (default: "_self")
    - ctaRel: Optional CTA button rel attribute
    - ctaId: Optional CTA button id attribute
    - ctaAriaLabel: Optional CTA button aria-label (defaults to button text)
    - secondaryCta: Optional secondary CTA button text for this feature
    - secondaryCtaUrl: Optional secondary CTA button URL for this feature
    - secondaryCtaStyle: Optional secondary CTA button style class (default: "border border-gray-300 text-gray-700 hover:bg-gray-50")
    - secondaryCtaTarget: Optional secondary CTA button target attribute (default: "_self")
    - secondaryCtaRel: Optional secondary CTA button rel attribute
    - secondaryCtaId: Optional secondary CTA button id attribute
    - secondaryCtaAriaLabel: Optional secondary CTA button aria-label (defaults to button text)
    - imageUrl: URL to feature image
    - imageAlt: Alt text for feature image
    - imagePosition: Position of the image ("left" or "right")
  - page: Page context for linkbuilding
*/}}

{{ $backgroundColor := .backgroundColor | default "bg-white" }}
{{ $heading := .heading | default "" }}
{{ $description := .description | default "" }}
{{ $layoutSize := .layoutSize | default "small-text" }}
{{ $headingClass := .headingClass | default "text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl" }}
{{ $descriptionClass := .descriptionClass | default "mt-4 text-gray-500" }}
{{ $page := .page }}

{{/* Define layout classes based on layoutSize */}}
{{ $textColClasses := "" }}
{{ $imageColClasses := "" }}
{{ $textColStartClasses := "" }}
{{ $imageColStartClasses := "" }}
{{ $headingClasses := "" }}
{{ $textClasses := "" }}

{{ if eq $layoutSize "balanced" }}
  {{/* 50/50 split */}}
  {{ $textColClasses = "lg:col-span-6" }}
  {{ $headingClasses = "text-3xl" }}
  {{ $textClasses = "text-base" }}
  {{ $imageColClasses = "lg:col-span-6" }}
  {{ $textColStartClasses = "lg:col-start-7" }}
  {{ $imageColStartClasses = "lg:col-start-1" }}
{{ else if eq $layoutSize "wide-text" }}
  {{/* Wide text, small image (7/5 split on lg, 8/4 on xl) */}}
  {{ $textColClasses = "lg:col-span-7 xl:col-span-8" }}
  {{ $headingClasses = "text-4xl" }}
  {{ $textClasses = "text-lg" }}
  {{ $imageColClasses = "lg:col-span-5 xl:col-span-4" }}
  {{ $textColStartClasses = "lg:col-start-6 xl:col-start-5" }}
  {{ $imageColStartClasses = "lg:col-start-1" }}
{{ else }}
  {{/* Default: small-text (current layout - 5/7 split on lg, 4/8 on xl) */}}
  {{ $textColClasses = "lg:col-span-5 xl:col-span-4" }}
  {{ $headingClasses = "text-lg" }}
  {{ $textClasses = "text-sm" }}
  {{ $imageColClasses = "lg:col-span-7 xl:col-span-8" }}
  {{ $textColStartClasses = "lg:col-start-8 xl:col-start-9" }}
  {{ $imageColStartClasses = "lg:col-start-1" }}
{{ end }}

{{ $features := .features | default (slice 
  (dict 
    "title" ""
    "description" ""
    "imageUrl" ""
    "imageAlt" ""
    "imagePosition" "right"
  )
  (dict 
    "title" ""
    "description" ""
    "imageUrl" ""
    "imageAlt" ""
    "imagePosition" "left"
  )
) }}

<div class="{{ $backgroundColor }}">
  <div class="wrapper py-24 sm:py-32">
    <div class="mx-auto max-w-3xl text-center">
      {{ if $heading }}
        <h2 class="{{ $headingClass }}">{{ $heading }}</h2>
      {{ end }}
      {{ if $description }}
        <p class="{{ $descriptionClass }}">{{ $description | safeHTML }}</p>
      {{ end }}
    </div>

    <div class="mt-16 space-y-16">
      {{ range $index, $feature := $features }}
        <div class="flex flex-col-reverse lg:grid lg:grid-cols-12 lg:items-center lg:gap-x-8">
          {{ if eq $feature.imagePosition "right" }}
            <div class="mt-6 {{ $textColClasses }} lg:col-start-1 lg:row-start-1 lg:mt-0">
              <h2 class="{{ $headingClasses }} font-medium text-gray-900">{{ $feature.title }}</h2>
              <p class="mt-2 {{ $textClasses }} text-gray-500">{{ $feature.description | safeHTML }}</p>
              
              {{/* Partner Logos - Optimized with smaller images */}}
              {{ if $feature.logos }}
                <div class="mt-8 pt-6 border-t border-gray-100">
                  <p class="text-[10px] font-bold uppercase tracking-widest mb-4" style="color: #737373;">Powered by</p>
                  <div class="flex items-center gap-8">
                    {{ range $i, $logo := $feature.logos }}
                      <div class="h-8 md:h-10 w-auto relative logo-pulse" style="min-width: 120px; animation-delay: {{ mul $i 2 }}s;">
                        <img src="{{ partial "functions/get-localized-image.html" $logo }}" alt="Partner Logo" class="h-full w-auto object-contain" loading="lazy" width="200" height="40" decoding="async">
                      </div>
                    {{ end }}
                  </div>
                </div>
                <style>
                  @keyframes logoPulse {
                    0%, 100% { filter: grayscale(1); opacity: 0.5; }
                    50% { filter: grayscale(0); opacity: 1; }
                  }
                  .logo-pulse {
                    animation: logoPulse 6s ease-in-out infinite;
                  }
                </style>
              {{ end }}

              {{/* Feature Cards - 2x2 Grid (案B) */}}
              {{ if $feature.featureCards }}
                <div class="mt-6 grid grid-cols-2 gap-3">
                  {{ range $feature.featureCards }}
                    <div class="flex items-center gap-3 p-3 bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl">
                      {{/* Icon */}}
                      <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600">
                        {{ if eq .icon "chatbot" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                          </svg>
                        {{ else if eq .icon "ticket" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                          </svg>
                        {{ else if eq .icon "email" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                          </svg>
                        {{ else if eq .icon "assist" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                          </svg>
                        {{ else if eq .icon "content" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                          </svg>
                        {{ else if eq .icon "web" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                          </svg>
                        {{ else }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                          </svg>
                        {{ end }}
                      </div>
                      {{/* Text Content */}}
                      <div class="min-w-0">
                        <h3 class="text-sm font-semibold text-gray-900">{{ .title }}</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">{{ .description }}</p>
                      </div>
                    </div>
                  {{ end }}
                </div>
              {{ end }}

              {{ if $feature.listItems }}
                <ul class="mt-4 pl-0 space-y-2">
                  {{ range $feature.listItems }}
                    <li class="flex items-start pl-0">
                      <svg class="h-4 w-4 text-primary mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                      </svg>
                      <span class="{{ $textClasses }} text-gray-600">{{ . | safeHTML }}</span>
                    </li>
                  {{ end }}
                </ul>
              {{ end }}
              {{ if or $feature.ctaText $feature.secondaryCta }}
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                  {{ if $feature.ctaText }}
                    {{ partial "components/buttons/buttons.html" (dict 
                      "text" $feature.ctaText
                      "url" $feature.ctaUrl
                      "variant" "primary"
                      "classes" $feature.ctaStyle
                      "target" $feature.ctaTarget
                      "rel" $feature.ctaRel
                      "id" $feature.ctaId
                      "ariaLabel" $feature.ctaAriaLabel
                    ) }}
                  {{ end }}
                  {{ if $feature.secondaryCta }}
                    {{ partial "components/buttons/buttons.html" (dict 
                      "text" $feature.secondaryCta
                      "url" $feature.secondaryCtaUrl
                      "variant" "secondary"
                      "classes" $feature.secondaryCtaStyle
                      "target" $feature.secondaryCtaTarget
                      "rel" $feature.secondaryCtaRel
                      "id" $feature.secondaryCtaId
                      "ariaLabel" $feature.secondaryCtaAriaLabel
                    ) }}
                  {{ end }}
                </div>
              {{ end }}
            </div>
            <div class="flex-auto {{ $imageColClasses }} {{ if eq $layoutSize "balanced" }}lg:col-start-7{{ else if eq $layoutSize "wide-text" }}lg:col-start-8 xl:col-start-9{{ else }}lg:col-start-6 xl:col-start-5{{ end }} lg:row-start-1">
              {{ if $feature.video }}
                {{ if $feature.videoTitle }}
                  <h3 class="mb-4 text-base font-semibold text-gray-900">{{ $feature.videoTitle }}</h3>
                {{ end }}
                {{/* Lite YouTube - Click to load */}}
                <div class="lite-youtube-feature relative w-full rounded-lg overflow-hidden shadow-xl cursor-pointer" 
                     data-videoid="{{ $feature.video }}" 
                     data-title="{{ $feature.videoTitle | default $feature.title }}"
                     style="padding-top: 56.25%;">
                  <picture>
                    <source type="image/webp" srcset="https://i.ytimg.com/vi_webp/{{ $feature.video }}/maxresdefault.webp">
                    <img src="https://i.ytimg.com/vi/{{ $feature.video }}/maxresdefault.jpg" 
                         alt="{{ $feature.videoTitle | default $feature.title }}"
                         loading="lazy"
                         width="1280"
                         height="720"
                         class="absolute inset-0 w-full h-full object-cover transition-all duration-300 hover:brightness-90">
                  </picture>
                  <button type="button" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-12 bg-red-600 rounded-lg hover:bg-red-700 hover:scale-110 transition-all duration-200 z-10 flex items-center justify-center" aria-label="Play video">
                    <svg class="w-6 h-6 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </button>
                </div>
              {{ else }}
                {{ partial "components/media/lazyimg.html" (dict 
                  "src" (partial "functions/get-localized-image.html" $feature.imageUrl)
                  "alt" $feature.imageAlt
                  "class" "aspect-3/2 w-full rounded-lg object-cover"
                ) }}
              {{ end }}
            </div>
          {{ else }}
            <div class="mt-6 {{ $textColClasses }} {{ $textColStartClasses }} lg:row-start-1 lg:mt-0">
              <h2 class="{{ $headingClasses }} font-medium text-gray-900">{{ $feature.title }}</h2>
              <p class="mt-2 {{ $textClasses }} text-gray-500">{{ $feature.description | safeHTML }}</p>
              
              {{/* Partner Logos - Optimized with smaller images */}}
              {{ if $feature.logos }}
                <div class="mt-8 pt-6 border-t border-gray-100">
                  <p class="text-[10px] font-bold uppercase tracking-widest mb-4" style="color: #737373;">Powered by</p>
                  <div class="flex items-center gap-8">
                    {{ range $i, $logo := $feature.logos }}
                      <div class="h-8 md:h-10 w-auto relative logo-pulse" style="min-width: 120px; animation-delay: {{ mul $i 2 }}s;">
                        <img src="{{ partial "functions/get-localized-image.html" $logo }}" alt="Partner Logo" class="h-full w-auto object-contain" loading="lazy" width="200" height="40" decoding="async">
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{/* Feature Cards - 2x2 Grid (案B) */}}
              {{ if $feature.featureCards }}
                <div class="mt-6 grid grid-cols-2 gap-3">
                  {{ range $feature.featureCards }}
                    <div class="flex items-center gap-3 p-3 bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl">
                      {{/* Icon */}}
                      <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600">
                        {{ if eq .icon "chatbot" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                          </svg>
                        {{ else if eq .icon "ticket" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                          </svg>
                        {{ else if eq .icon "email" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                          </svg>
                        {{ else if eq .icon "assist" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                          </svg>
                        {{ else if eq .icon "content" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                          </svg>
                        {{ else if eq .icon "web" }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                          </svg>
                        {{ else }}
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                          </svg>
                        {{ end }}
                      </div>
                      {{/* Text Content */}}
                      <div class="min-w-0">
                        <h3 class="text-sm font-semibold text-gray-900">{{ .title }}</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">{{ .description }}</p>
                      </div>
                    </div>
                  {{ end }}
                </div>
              {{ end }}

              {{ if $feature.listItems }}
                <ul class="mt-4 pl-0 space-y-2">
                  {{ range $feature.listItems }}
                    <li class="flex items-start pl-0">
                      {{ partial "icons/check" "w-4 h-4 text-primary mt-0.5 mr-2 flex-shrink-0" }}
                      <span class="{{ $textClasses }} text-gray-600">{{ . | safeHTML }}</span>
                    </li>
                  {{ end }}
                </ul>
              {{ end }}
              {{ if or $feature.ctaText $feature.secondaryCta }}
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                  {{ if $feature.ctaText }}
                    {{ partial "components/buttons/buttons.html" (dict 
                      "text" $feature.ctaText
                      "url" $feature.ctaUrl
                      "variant" "primary"
                      "classes" $feature.ctaStyle
                      "target" $feature.ctaTarget
                      "rel" $feature.ctaRel
                      "id" $feature.ctaId
                      "ariaLabel" $feature.ctaAriaLabel
                    ) }}
                  {{ end }}
                  {{ if $feature.secondaryCta }}
                    {{ partial "components/buttons/buttons.html" (dict 
                      "text" $feature.secondaryCta
                      "url" $feature.secondaryCtaUrl
                      "variant" "secondary"
                      "classes" $feature.secondaryCtaStyle
                      "target" $feature.secondaryCtaTarget
                      "rel" $feature.secondaryCtaRel
                      "id" $feature.secondaryCtaId
                      "ariaLabel" $feature.secondaryCtaAriaLabel
                    ) }}
                  {{ end }}
                </div>
              {{ end }}
            </div>
            <div class="flex-auto {{ $imageColClasses }} {{ $imageColStartClasses }} lg:row-start-1">
              {{ if $feature.video }}
                {{ if $feature.videoTitle }}
                  <h3 class="mb-4 text-base font-semibold text-gray-900">{{ $feature.videoTitle }}</h3>
                {{ end }}
                {{/* Lite YouTube - Click to load */}}
                <div class="lite-youtube-feature relative w-full rounded-lg overflow-hidden shadow-xl cursor-pointer" 
                     data-videoid="{{ $feature.video }}" 
                     data-title="{{ $feature.videoTitle | default $feature.title }}"
                     style="padding-top: 56.25%;">
                  <picture>
                    <source type="image/webp" srcset="https://i.ytimg.com/vi_webp/{{ $feature.video }}/maxresdefault.webp">
                    <img src="https://i.ytimg.com/vi/{{ $feature.video }}/maxresdefault.jpg" 
                         alt="{{ $feature.videoTitle | default $feature.title }}"
                         loading="lazy"
                         width="1280"
                         height="720"
                         class="absolute inset-0 w-full h-full object-cover transition-all duration-300 hover:brightness-90">
                  </picture>
                  <button type="button" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-12 bg-red-600 rounded-lg hover:bg-red-700 hover:scale-110 transition-all duration-200 z-10 flex items-center justify-center" aria-label="Play video">
                    <svg class="w-6 h-6 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </button>
                </div>
              {{ else }}
                {{ partial "components/media/lazyimg.html" (dict 
                  "src" (partial "functions/get-localized-image.html" $feature.imageUrl)
                  "alt" $feature.imageAlt
                  "class" "aspect-3/2 w-full rounded-lg object-cover"
                ) }}
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ end }}
    </div>
  </div>
</div>

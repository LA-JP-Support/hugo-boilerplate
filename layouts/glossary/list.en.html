{{ define "main" }}

{{/* Configuration variables */}}
{{ $cardHeight := 252 }}

  <div class="bg-white dark:bg-gray-900">
    {{/* 用語集専用ヒーロー - アニメーション背景付き */}}
    <div class="relative overflow-visible z-0">
      <div class="glossary-hero-animated-bg absolute inset-0 z-0"></div>
      <div class="glossary-hero-overlay absolute inset-0 z-0"></div>
      <div class="glossary-hero-glow absolute inset-0 z-[5]">
        <div class="glossary-hero-glow-orb"></div>
      </div>
      <div class="relative z-10 py-12 sm:py-16">
        <div class="wrapper">
          <div class="mx-auto max-w-2xl text-center">
            <h1 class="text-3xl font-bold tracking-tight text-white sm:text-4xl md:text-5xl">
              {{ .Title }}
            </h1>
            {{ if .Description }}
              <p class="mt-4 sm:mt-6 text-base sm:text-lg leading-7 text-gray-200">
                {{ .Description }}
              </p>
            {{ end }}
          </div>

          <div class="mt-6 sm:mt-8 max-w-xl mx-auto">
            {{ partial "search_field.html" (dict
              "type" "glossary-archive-search-en"
              "marginClass" "mt-4"
              "directories" (slice "glossary")
            ) }}
          </div>
        </div>
      </div>
    </div>

    {{/* アルファベットナビゲーションと記事リスト */}}
    {{ $letters := slice "0-9" "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S" "T" "U" "V" "W" "X" "Y" "Z" }}
    {{ $activeLetter := "" }}
    {{ with .Title }}
      {{ $activeLetter = substr . 0 1 | upper }}
    {{ end }}
    {{ $glossaryTerms := where .Site.RegularPages "Section" "glossary" }}
    {{ $glossaryTerms = where $glossaryTerms "Language.Lang" .Language.Lang }}
    
    <div id="alphabetNav" class="w-full bg-white dark:bg-gray-900 sticky top-20 md:top-[5.25rem] z-[45] transition-all duration-300">
      <div class="wrapper px-8 ">
        <div class="grid grid-cols-2 lg:hidden">
          <select class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white dark:bg-gray-800 py-2 pl-3 pr-8 text-base text-gray-900 dark:text-white" id="alphabetSelect">
            {{ range $letters }}
              <option value="{{ . }}" {{ if eq . $activeLetter }}selected{{ end }}>{{ . }}</option>
            {{ end }}
          </select>
        </div>

        <div class="hidden lg:block">
          <nav class="flex flex-wrap gap-2 py-6 justify-between">
            {{ range $letters }}
              {{ $letter := . }}
              {{ $hasTerms := false }}
              {{ range $glossaryTerms }}
                {{/* アルファベット順の分類は常にタイトルの最初の文字を使用 */}}
                {{ $termName := .Params.term | default .Title }}
                {{ $firstChar := substr $termName 0 1 | upper }}
                {{ $letterCategory := "" }}
                {{ if in $letters $firstChar }}
                  {{ $letterCategory = $firstChar }}
                {{ else }}
                  {{ $letterCategory = "0-9" }}
                {{ end }}
                {{ if eq $letterCategory $letter }}
                  {{ $hasTerms = true }}
                {{ end }}
              {{ end }}
              <a href="javascript:void(0)" data-letter="{{ $letter }}"
                 class="rounded-md px-2 py-2 text-sm font-medium
                 {{ if eq $letter $activeLetter }}bg-indigo-100 dark:bg-indigo-900 text-primary aria-current='page'
                 {{ else if $hasTerms }}text-tertiary hover:text-primary hover:bg-indigo-100 dark:hover:bg-indigo-900
                 {{ else }}text-tertiary opacity-30 pointer-events-none{{ end }}">
                {{ $letter }}
              </a>
            {{ end }}
          </nav>
        </div>

      </div>
    </div>
    <div class="wrapper mt-10">
      {{ range $letters }}
        {{ $letter := . }}
        {{ $termsInCategory := slice }}
        {{ range $glossaryTerms }}
          {{/* アルファベット順の分類は常にタイトルの最初の文字を使用 */}}
          {{ $termName := .Params.term | default .Title }}
          {{ $firstChar := substr $termName 0 1 | upper }}
          {{ $letterCategory := "" }}
          {{ if in $letters $firstChar }}
            {{ $letterCategory = $firstChar }}
          {{ else }}
            {{ $letterCategory = "0-9" }}
          {{ end }}
          {{ if eq $letterCategory $letter }}
            {{ $termsInCategory = $termsInCategory | append . }}
          {{ end }}
        {{ end }}
        {{ if $termsInCategory }}
          <div id="{{ $letter }}" class="my-10">
            <h2 class="text-5xl font-semibold text-heading dark:text-white">{{ $letter }}</h2>
            <ul class="mt-8 grid gap-10 sm:grid-cols-2 lg:grid-cols-3">
              {{ range sort $termsInCategory "Title" }}
                {{ partial "components/cards/post_card_with_image.html" (
                  dict "page" . "cardHeight" $cardHeight
                  "showImages" false
                  "showDateReadingTime" false
                ) }}
              {{ end }}
            </ul>
          </div>
        {{ end }}
      {{ end }}
    </div>
  </div>

  {{ if .Content }}
    {{ partial "sections/content/centered.html" (dict
        "content" .Content
        "bgColor" "bg-gray-50 dark:bg-gray-800"
        "page" .
    ) }}
  {{ end }}

  <script>
    // ページ読み込み前にスクロール位置をリセット
    if (window.history.scrollRestoration) {
      window.history.scrollRestoration = 'manual';
    }

    document.addEventListener("DOMContentLoaded", function() {
      // ページ読み込み時に強制的にトップにスクロール
      if (!window.location.search.includes('term=')) {
        window.scrollTo(0, 0);
        // URLからハッシュを削除
        if (window.location.hash) {
          history.replaceState(null, null, window.location.pathname + window.location.search);
        }
        // 確実にトップに戻すため、少し遅延させて再度実行
        setTimeout(() => window.scrollTo(0, 0), 0);
        setTimeout(() => window.scrollTo(0, 0), 100);
      }

      const select = document.getElementById("alphabetSelect");
      const tabsContainer = document.querySelector('#alphabetNav nav');
      const sections = document.querySelectorAll('.wrapper > div[id]');
      const alphabetNav = document.getElementById('alphabetNav');
      const header = document.querySelector('header');

      const activeClasses = ['bg-indigo-100', 'dark:bg-indigo-900', 'text-primary'];
      const defaultClasses = ['text-secondary', 'hover:text-primary', 'hover:bg-indigo-100', 'dark:hover:bg-indigo-900'];
      const disabledClasses = ['text-gray-500', 'opacity-30', 'pointer-events-none']; 
      const allDynamicClasses = [...activeClasses, ...defaultClasses, ...disabledClasses];

      const scrollThreshold = 31.5 * 16;
      const borderClasses = ['border-b', 'border-gray-300', 'dark:border-gray-700'];

      function setActiveTab(letterToActivate) {
        if (!tabsContainer) return;

        const tabs = tabsContainer.querySelectorAll('a');
        tabs.forEach(tab => {
          const tabLetter = tab.getAttribute('href').replace('#', '');
          tab.classList.remove(...allDynamicClasses);
          tab.removeAttribute('aria-current');

          const hasTermsForThisLetter = Array.from(sections).some(section => section.id === tabLetter);

          if (tabLetter === letterToActivate) {
            tab.classList.add(...activeClasses);
            tab.setAttribute('aria-current', 'page');
          } else if (hasTermsForThisLetter) {
            tab.classList.add(...defaultClasses);
          } else {
            tab.classList.add(...disabledClasses);
          }
        });

        if (select) {
          select.value = letterToActivate;
        }
      }

      function handleScroll() {
        // Only apply border logic for desktop screens (sm: 640px and up)
        if (window.innerWidth >= 1024) {
          if (window.scrollY > scrollThreshold) {
            alphabetNav?.classList.add(...borderClasses);
          } else {
            alphabetNav?.classList.remove(...borderClasses);
          }
        } else {
          // Remove border classes on mobile
          alphabetNav?.classList.remove(...borderClasses);
        }
      }

      // ページタイトルに基づく自動スクロール（Gへのジャンプ）を無効化
      // const initialActiveLetter = "{{ $activeLetter }}";
      // if (initialActiveLetter) {
      //   setActiveTab(initialActiveLetter);
      //   document.getElementById(initialActiveLetter)?.scrollIntoView({ behavior: "auto", block: "start" });
      // }

      if (select) {
        select.addEventListener("change", function() {
          const sectionId = this.value;
          document.getElementById(sectionId)?.scrollIntoView({ behavior: "smooth", block: "start" });
          setActiveTab(sectionId);
        });
      }

      if (tabsContainer) {
        tabsContainer.addEventListener('click', function(e) {
          const targetTab = e.target.closest('a');
          if (targetTab && !targetTab.classList.contains('pointer-events-none')) {
            e.preventDefault();
            const letter = targetTab.dataset.letter;
            setActiveTab(letter);
            const section = document.getElementById(letter);
            if (section) {
              const header = document.querySelector('header');
              const alphabetNav = document.getElementById('alphabetNav');
              const extraSpace = -16; // px navyše pod headerom a abecedou
              const offset = (header?.offsetHeight || 0) + (alphabetNav?.offsetHeight || 0) - extraSpace;
              const sectionTop = section.getBoundingClientRect().top + window.pageYOffset;
              window.scrollTo({
                top: sectionTop - offset,
                left: 0,
                behavior: 'smooth'
              });
            }
          }
        });
      }

      const observerOptions = {
        root: null,
        rootMargin: "-20% 0px -80% 0px",
        threshold: 0
      };

      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            setActiveTab(entry.target.id);
          }
        });
      }, observerOptions);

      sections.forEach(section => observer.observe(section));

      window.addEventListener('scroll', handleScroll);
      handleScroll();
    });
  </script>

<style>
@keyframes glossaryGradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes glossaryFloat {
  0%, 100% { transform: translate(0px, 0px); }
  25% { transform: translate(30px, -50px); }
  50% { transform: translate(-20px, -100px); }
  75% { transform: translate(-50px, -50px); }
}

.glossary-hero-animated-bg {
  background: linear-gradient(135deg, #059669 0%, #0d9488 25%, #10b981 50%, #14b8a6 75%, #059669 100%);
  background-size: 400% 400%;
  animation: glossaryGradientShift 10s ease infinite;
}

.glossary-hero-animated-bg::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 420px;
  height: 420px;
  background: rgba(255,255,255,0.10);
  border-radius: 50%;
  animation: glossaryFloat 20s ease-in-out infinite;
}

.glossary-hero-animated-bg::after {
  content: '';
  position: absolute;
  bottom: 0;
  right: 0;
  width: 320px;
  height: 320px;
  background: rgba(255,255,255,0.10);
  border-radius: 50%;
  animation: glossaryFloat 25s ease-in-out infinite reverse;
}

.glossary-hero-overlay {
  background: linear-gradient(180deg, rgba(2, 6, 23, 0.12) 0%, rgba(2, 6, 23, 0.26) 100%);
  pointer-events: none;
}

.glossary-hero-glow {
  pointer-events: none;
}

.glossary-hero-glow-orb {
  position: absolute;
  width: 280px;
  height: 280px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.22) 0%, rgba(255, 255, 255, 0.00) 70%);
  border-radius: 50%;
  filter: blur(44px);
  transform: translate(-50%, -50%);
  opacity: 0.9;
  top: 50%;
  left: 50%;
}
</style>
  
{{ end }}
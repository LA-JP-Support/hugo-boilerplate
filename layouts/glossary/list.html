{{ define "main" }}

{{/* Configuration variables */}}
{{ $cardHeight := 252 }}

  <div class="bg-white dark:bg-gray-900">
    {{/* 用語集専用のシンプルヒーロー */}}
    <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-indigo-700 dark:from-gray-800 dark:via-gray-900 dark:to-black py-12 sm:py-16">
      <div class="wrapper">
        <div class="mx-auto max-w-2xl text-center">
          <h1 class="text-4xl font-bold tracking-tight text-white sm:text-5xl">
            {{ .Title }}
          </h1>
          {{ if .Description }}
            <p class="mt-4 text-lg text-white/90">
              {{ .Description }}
            </p>
          {{ end }}
        </div>

        <div class="mt-8 max-w-xl mx-auto">
          {{ partial "search_field.html" (dict
            "type" "glossary-archive-search"
            "marginClass" "mt-4"
            "directories" (slice "glossary")
          ) }}
        </div>
      </div>
    </div>

    {{/* 五十音ナビゲーションと記事リスト */}}
    {{ $kanaGroups := slice "あ行" "か行" "さ行" "た行" "な行" "は行" "ま行" "や行" "ら行" "わ行" "0-9" "A-Z" }}
    {{ $kanaSubGroups := dict "あ行" (slice "あ" "い" "う" "え" "お") "か行" (slice "か" "き" "く" "け" "こ") "さ行" (slice "さ" "し" "す" "せ" "そ") "た行" (slice "た" "ち" "つ" "て" "と") "な行" (slice "な" "に" "ぬ" "ね" "の") "は行" (slice "は" "ひ" "ふ" "へ" "ほ") "ま行" (slice "ま" "み" "む" "め" "も") "や行" (slice "や" "ゆ" "よ") "ら行" (slice "ら" "り" "る" "れ" "ろ") "わ行" (slice "わ" "を" "ん") }}
    {{ $alphabetGroups := slice "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S" "T" "U" "V" "W" "X" "Y" "Z" }}
    {{ $activeLetter := "" }}
    {{ with .Title }}
      {{ $activeLetter = substr . 0 1 }}
    {{ end }}
    {{ $glossaryTerms := where .Site.RegularPages "Section" "glossary" }}
    {{ $glossaryTerms = where $glossaryTerms "Language.Lang" .Language.Lang }}
    
    <div id="alphabetNav" class="w-full bg-white dark:bg-gray-900 sticky top-20 md:top-[5.25rem] z-[45] transition-all duration-300">
      <div class="wrapper px-8 ">
        {{/* モバイル用ドロップダウン */}}
        <div class="grid grid-cols-2 lg:hidden">
          <select class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white dark:bg-gray-800 py-2 pl-3 pr-8 text-base text-gray-900 dark:text-white" id="alphabetSelect">
            {{ range $kanaGroups }}
              {{ $group := . }}
              {{ if or (eq $group "0-9") (eq $group "A-Z") }}
                <option value="{{ $group }}" {{ if eq $group $activeLetter }}selected{{ end }}>{{ $group }}</option>
              {{ else }}
                <optgroup label="{{ $group }}">
                  <option value="{{ $group }}" {{ if eq $group $activeLetter }}selected{{ end }}>{{ $group }}（全体）</option>
                  {{ range index $kanaSubGroups $group }}
                    <option value="{{ . }}" {{ if eq . $activeLetter }}selected{{ end }}>　{{ . }}</option>
                  {{ end }}
                </optgroup>
              {{ end }}
            {{ end }}
            <optgroup label="A-Z">
              <option value="A-Z">A-Z（全体）</option>
              {{ range $alphabetGroups }}
                <option value="{{ . }}">　{{ . }}</option>
              {{ end }}
            </optgroup>
            <option value="0-9">0-9</option>
          </select>
        </div>

        {{/* デスクトップ用ナビゲーション */}}
        <div class="hidden lg:block">
          <nav class="flex flex-wrap gap-2 py-6 justify-between" id="mainNav">
            {{ range $kanaGroups }}
              {{ $group := . }}
              <div class="relative group" data-nav-group="{{ $group }}">
                <a href="javascript:void(0)" data-group="{{ $group }}"
                   class="kana-nav-link rounded-md px-3 py-2 text-sm font-medium whitespace-nowrap inline-flex items-center gap-1
                   {{ if eq $group $activeLetter }}bg-indigo-100 dark:bg-indigo-900 text-primary aria-current='page'
                   {{ else }}text-tertiary hover:text-primary hover:bg-indigo-100 dark:hover:bg-indigo-900{{ end }}">
                  {{ $group }}
                  {{ if eq $group "A-Z" }}
                    <svg class="w-4 h-4 transition-transform" data-expand-icon="{{ $group }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  {{ end }}
                </a>
                {{/* サブナビゲーション（あ行など） */}}
                {{ if and (ne $group "0-9") (ne $group "A-Z") }}
                  <div class="sub-nav hidden group-hover:block group-focus-within:block absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-700 p-2 z-[60] whitespace-nowrap pointer-events-auto" data-subnav="{{ $group }}">
                    {{ range index $kanaSubGroups $group }}
                      <a href="#{{ . }}" data-subgroup="{{ . }}" data-parent="{{ $group }}"
                         class="block px-3 py-1.5 text-sm rounded cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900 text-tertiary hover:text-primary pointer-events-auto">
                        {{ . }}
                      </a>
                    {{ end }}
                  </div>
                {{ end }}
                {{/* A-Z展開サブナビ */}}
                {{ if eq $group "A-Z" }}
                  <div class="sub-nav hidden group-hover:block group-focus-within:block absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-700 p-2 z-[60] pointer-events-auto" data-subnav="A-Z" style="width: 160px;">
                    <div class="grid grid-cols-2 gap-1">
                      {{ range $alphabetGroups }}
                        <a href="#{{ . }}" data-subgroup="{{ . }}" data-parent="A-Z"
                           class="flex items-center justify-center w-full h-9 text-sm rounded cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900 text-tertiary hover:text-primary font-medium pointer-events-auto">
                          {{ . }}
                        </a>
                      {{ end }}
                    </div>
                  </div>
                {{ end }}
              </div>
            {{ end }}
          </nav>
        </div>

      </div>
    </div>

    <div class="wrapper mt-10">
      {{ range $kanaGroups }}
        {{ $group := . }}
        {{/* 行レベルセクションは0-9とA-Zのみ表示 */}}
        {{ if or (eq $group "0-9") (eq $group "A-Z") }}
          <div id="{{ $group }}" class="my-10" data-group="{{ $group }}" style="display:none;">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-3xl sm:text-4xl font-semibold text-heading dark:text-white">{{ $group }}</h2>
            </div>
            <ul class="mt-8 grid gap-10 sm:grid-cols-2 lg:grid-cols-3" data-terms-container="{{ $group }}">
              {{/* 用語はJavaScriptで動的に配置される */}}
            </ul>
          </div>
        {{ end }}
      {{ end }}
      {{/* 個別文字セクション（あ、い、う...、A、B、C...） */}}
      {{ range $kanaGroups }}
        {{ $parentGroup := . }}
        {{ if ne $parentGroup "0-9" }}
          {{ $subGroups := cond (eq $parentGroup "A-Z") $alphabetGroups (index $kanaSubGroups $parentGroup) }}
          {{ range $subGroups }}
            {{ $subGroup := . }}
            <div id="{{ $subGroup }}" class="my-10" data-subgroup="{{ $subGroup }}" data-parent="{{ $parentGroup }}" style="display:none;">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl sm:text-3xl font-semibold text-heading dark:text-white">{{ $subGroup }}</h3>
                {{/* 日本語の行のサブナビ（たちつてと等） */}}
                {{ if ne $parentGroup "A-Z" }}
                  <div class="flex gap-2" data-section-subnav="{{ $parentGroup }}">
                    {{ range index $kanaSubGroups $parentGroup }}
                      <a href="#{{ . }}" data-section-link="{{ . }}"
                         class="px-3 py-1 text-sm rounded-md text-tertiary hover:text-primary hover:bg-indigo-50 dark:hover:bg-indigo-900 transition-colors">
                        {{ . }}
                      </a>
                    {{ end }}
                  </div>
                {{ end }}
              </div>
              <ul class="mt-8 grid gap-10 sm:grid-cols-2 lg:grid-cols-3" data-terms-container="{{ $subGroup }}">
                {{/* 用語はJavaScriptで動的に配置される */}}
              </ul>
            </div>
          {{ end }}
        {{ end }}
      {{ end }}
    </div>
  </div>

  {{/* すべての用語をJSON形式で埋め込み */}}
  <script id="glossary-terms-data" type="application/json">
  [
    {{ range $index, $term := $glossaryTerms }}
      {{ if $index }},{{ end }}
      {
        "title": "{{ $term.Title | safeJS }}",
        "eTitle": "{{ (or (index $term.Params "e-title") "") | safeJS }}",
        {{ $termVal := $term.Params.term | default $term.Title }}
        {{ if reflect.IsSlice $termVal }}{{ $termVal = index $termVal 0 }}{{ end }}
        "term": "{{ $termVal | safeJS }}",
        "url": {{ $term.RelPermalink | jsonify }},
        "description": "{{ $term.Description | safeJS }}",
        "image": {{ ($term.Params.image | default "") | jsonify }},
        "date": {{ $term.Date.Format "2006-01-02" | jsonify }},
        "readingTime": {{ $term.ReadingTime }}
      }
    {{ end }}
  ]
  </script>

  {{ if .Content }}
    {{ partial "sections/content/centered.html" (dict
        "content" .Content
        "bgColor" "bg-gray-50 dark:bg-gray-800"
        "page" .
    ) }}
  {{ end }}

  <script>
    // ページ読み込み前にスクロール位置をリセット
    if (window.history.scrollRestoration) {
      window.history.scrollRestoration = 'manual';
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      // ページ読み込み時に強制的にトップにスクロール
      if (!window.location.search.includes('term=')) {
        window.scrollTo(0, 0);
        // URLからハッシュを削除
        if (window.location.hash) {
          history.replaceState(null, null, window.location.pathname + window.location.search);
        }
      }
      
      // JSON埋め込み時に二重引用符が付いている場合に外側の " を1組だけ削る
      function stripOuterQuotes(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/^"(.*)"$/, '$1');
      }

      const select = document.getElementById("alphabetSelect");
      const tabsContainer = document.querySelector('#alphabetNav nav');
      const sections = document.querySelectorAll('.wrapper > div[id]');
      const alphabetNav = document.getElementById('alphabetNav');

      const activeClasses = ['bg-indigo-100', 'dark:bg-indigo-900', 'text-primary'];
      const defaultClasses = ['text-tertiary', 'hover:text-primary', 'hover:bg-indigo-100', 'dark:hover:bg-indigo-900'];
      const disabledClasses = ['text-gray-500', 'opacity-30', 'pointer-events-none']; 
      const allDynamicClasses = [...activeClasses, ...defaultClasses, ...disabledClasses];

      const scrollThreshold = 31.5 * 16;
      const borderClasses = ['border-b', 'border-gray-300', 'dark:border-gray-700'];

      function getScrollMarginTopPx() {
        const navHeight = alphabetNav?.offsetHeight || 0;
        const computedTop = alphabetNav ? parseFloat(window.getComputedStyle(alphabetNav).top) : 0;
        const navTop = Number.isFinite(computedTop) ? computedTop : 0;
        return navTop + navHeight + 96;
      }

      function applyScrollMargins() {
        const px = getScrollMarginTopPx();
        // すべてのセクション（0-9/A-Z/あ/い.../A/B...）に適用
        document.querySelectorAll('.wrapper.mt-10 > div[id]').forEach(el => {
          el.style.scrollMarginTop = `${px}px`;
        });
      }

      function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;
        section.style.display = 'block';
        applyScrollMargins();
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // 五十音行の判定関数（行レベル）
      function getKanaGroup(char) {
        const code = char.charCodeAt(0);
        
        // ひらがな判定
        if (code >= 0x3041 && code <= 0x3096) {
          if (/[あいうえおぁぃぅぇぉ]/.test(char)) return 'あ行';
          if (/[か-ごが-ご]/.test(char)) return 'か行';
          if (/[さ-ぞざ-ぞ]/.test(char)) return 'さ行';
          if (/[た-どだ-ど]/.test(char)) return 'た行';
          if (/[な-の]/.test(char)) return 'な行';
          if (/[は-ぽば-ぽ]/.test(char)) return 'は行';
          if (/[ま-も]/.test(char)) return 'ま行';
          if (/[や-よゃ-ょ]/.test(char)) return 'や行';
          if (/[ら-ろ]/.test(char)) return 'ら行';
          if (/[わ-んゎ-ゔ]/.test(char)) return 'わ行';
        }
        
        // カタカナ判定
        if (code >= 0x30A0 && code <= 0x30FF) {
          if (/[ア-オァ-ォ]/.test(char)) return 'あ行';
          if (/[カ-ゴガ-ゴ]/.test(char)) return 'か行';
          if (/[サ-ゾザ-ゾ]/.test(char)) return 'さ行';
          if (/[タ-ドダ-ド]/.test(char)) return 'た行';
          if (/[ナ-ノ]/.test(char)) return 'な行';
          if (/[ハ-ポバ-ポ]/.test(char)) return 'は行';
          if (/[マ-モ]/.test(char)) return 'ま行';
          if (/[ヤ-ヨャ-ョ]/.test(char)) return 'や行';
          if (/[ラ-ロ]/.test(char)) return 'ら行';
          if (/[ワ-ンヮ-ヴ]/.test(char)) return 'わ行';
        }
        
        // 数字
        if (/[0-9]/.test(char)) return '0-9';
        
        // アルファベット
        if (/[A-Za-z]/.test(char)) return 'A-Z';
        
        return null;
      }

      // 詳細な文字判定（あ、い、う、A、B、Cなど）
      function getDetailedChar(char) {
        const code = char.charCodeAt(0);
        
        // ひらがな
        if (code >= 0x3041 && code <= 0x3096) {
          // あ行
          if (/[あぁ]/.test(char)) return 'あ';
          if (/[いぃ]/.test(char)) return 'い';
          if (/[うぅ]/.test(char)) return 'う';
          if (/[えぇ]/.test(char)) return 'え';
          if (/[おぉ]/.test(char)) return 'お';
          // か行
          if (/[かが]/.test(char)) return 'か';
          if (/[きぎ]/.test(char)) return 'き';
          if (/[くぐ]/.test(char)) return 'く';
          if (/[けげ]/.test(char)) return 'け';
          if (/[こご]/.test(char)) return 'こ';
          // さ行
          if (/[さざ]/.test(char)) return 'さ';
          if (/[しじ]/.test(char)) return 'し';
          if (/[すず]/.test(char)) return 'す';
          if (/[せぜ]/.test(char)) return 'せ';
          if (/[そぞ]/.test(char)) return 'そ';
          // た行
          if (/[ただ]/.test(char)) return 'た';
          if (/[ちぢ]/.test(char)) return 'ち';
          if (/[つっづ]/.test(char)) return 'つ';
          if (/[てで]/.test(char)) return 'て';
          if (/[とど]/.test(char)) return 'と';
          // な行
          if (/[な]/.test(char)) return 'な';
          if (/[に]/.test(char)) return 'に';
          if (/[ぬ]/.test(char)) return 'ぬ';
          if (/[ね]/.test(char)) return 'ね';
          if (/[の]/.test(char)) return 'の';
          // は行
          if (/[はばぱ]/.test(char)) return 'は';
          if (/[ひびぴ]/.test(char)) return 'ひ';
          if (/[ふぶぷ]/.test(char)) return 'ふ';
          if (/[へべぺ]/.test(char)) return 'へ';
          if (/[ほぼぽ]/.test(char)) return 'ほ';
          // ま行
          if (/[ま]/.test(char)) return 'ま';
          if (/[み]/.test(char)) return 'み';
          if (/[む]/.test(char)) return 'む';
          if (/[め]/.test(char)) return 'め';
          if (/[も]/.test(char)) return 'も';
          // や行
          if (/[やゃ]/.test(char)) return 'や';
          if (/[ゆゅ]/.test(char)) return 'ゆ';
          if (/[よょ]/.test(char)) return 'よ';
          // ら行
          if (/[ら]/.test(char)) return 'ら';
          if (/[り]/.test(char)) return 'り';
          if (/[る]/.test(char)) return 'る';
          if (/[れ]/.test(char)) return 'れ';
          if (/[ろ]/.test(char)) return 'ろ';
          // わ行
          if (/[わゎ]/.test(char)) return 'わ';
          if (/[を]/.test(char)) return 'を';
          if (/[ん]/.test(char)) return 'ん';
        }
        
        // カタカナ→ひらがなに統一
        if (code >= 0x30A0 && code <= 0x30FF) {
          // あ行
          if (/[アァ]/.test(char)) return 'あ';
          if (/[イィ]/.test(char)) return 'い';
          if (/[ウゥヴ]/.test(char)) return 'う';
          if (/[エェ]/.test(char)) return 'え';
          if (/[オォ]/.test(char)) return 'お';
          // か行
          if (/[カガ]/.test(char)) return 'か';
          if (/[キギ]/.test(char)) return 'き';
          if (/[クグ]/.test(char)) return 'く';
          if (/[ケゲ]/.test(char)) return 'け';
          if (/[コゴ]/.test(char)) return 'こ';
          // さ行
          if (/[サザ]/.test(char)) return 'さ';
          if (/[シジ]/.test(char)) return 'し';
          if (/[スズ]/.test(char)) return 'す';
          if (/[セゼ]/.test(char)) return 'せ';
          if (/[ソゾ]/.test(char)) return 'そ';
          // た行
          if (/[タダ]/.test(char)) return 'た';
          if (/[チヂ]/.test(char)) return 'ち';
          if (/[ツッヅ]/.test(char)) return 'つ';
          if (/[テデ]/.test(char)) return 'て';
          if (/[トド]/.test(char)) return 'と';
          // な行
          if (/[ナ]/.test(char)) return 'な';
          if (/[ニ]/.test(char)) return 'に';
          if (/[ヌ]/.test(char)) return 'ぬ';
          if (/[ネ]/.test(char)) return 'ね';
          if (/[ノ]/.test(char)) return 'の';
          // は行
          if (/[ハバパ]/.test(char)) return 'は';
          if (/[ヒビピ]/.test(char)) return 'ひ';
          if (/[フブプ]/.test(char)) return 'ふ';
          if (/[ヘベペ]/.test(char)) return 'へ';
          if (/[ホボポ]/.test(char)) return 'ほ';
          // ま行
          if (/[マ]/.test(char)) return 'ま';
          if (/[ミ]/.test(char)) return 'み';
          if (/[ム]/.test(char)) return 'む';
          if (/[メ]/.test(char)) return 'め';
          if (/[モ]/.test(char)) return 'も';
          // や行
          if (/[ヤャ]/.test(char)) return 'や';
          if (/[ユュ]/.test(char)) return 'ゆ';
          if (/[ヨョ]/.test(char)) return 'よ';
          // ら行
          if (/[ラ]/.test(char)) return 'ら';
          if (/[リ]/.test(char)) return 'り';
          if (/[ル]/.test(char)) return 'る';
          if (/[レ]/.test(char)) return 'れ';
          if (/[ロ]/.test(char)) return 'ろ';
          // わ行
          if (/[ワヮ]/.test(char)) return 'わ';
          if (/[ヲ]/.test(char)) return 'を';
          if (/[ン]/.test(char)) return 'ん';
        }
        
        // アルファベット（大文字に統一）
        if (/[A-Za-z]/.test(char)) return char.toUpperCase();
        
        // 数字
        if (/[0-9]/.test(char)) return '0-9';
        
        return null;
      }

      // 用語データの読み込みと分類
      const termsData = JSON.parse(document.getElementById('glossary-terms-data').textContent);
      const groupedTerms = {};
      const detailedGroupedTerms = {};
      const kanaGroups = ['あ行', 'か行', 'さ行', 'た行', 'な行', 'は行', 'ま行', 'や行', 'ら行', 'わ行', '0-9', 'A-Z'];
      const lang = '{{ .Language.Lang }}';

      kanaGroups.forEach(group => groupedTerms[group] = []);

      termsData.forEach(term => {
        // 外側の "..." を削除してから利用する
        term.term = stripOuterQuotes(term.term);
        term.title = stripOuterQuotes(term.title);
        term.eTitle = stripOuterQuotes(term.eTitle);
        term.url = stripOuterQuotes(term.url);
        term.description = stripOuterQuotes(term.description);
        term.image = stripOuterQuotes(term.image);
        term.date = stripOuterQuotes(term.date);

        // titleフィールドを使用して分類（日本語の場合はtermを使用）
        const sortKey = term.title || term.term;
        const firstChar = sortKey.charAt(0);
        const group = getKanaGroup(firstChar);
        const detailedChar = getDetailedChar(firstChar);
        
        // 行レベルのグループ化
        if (group && groupedTerms[group]) {
          groupedTerms[group].push(term);
        }
        
        // 詳細な文字レベルのグループ化
        if (detailedChar) {
          if (!detailedGroupedTerms[detailedChar]) {
            detailedGroupedTerms[detailedChar] = [];
          }
          detailedGroupedTerms[detailedChar].push(term);
        }
      });

      // カード作成ヘルパー関数
      function createTermCard(term) {
        const li = document.createElement('li');
        li.className = 'group relative flex flex-col overflow-hidden rounded-xl bg-white dark:bg-gray-800 shadow-md hover:shadow-xl transition-shadow duration-300';
        
        li.innerHTML = `
          <a href="${term.url}" class="flex flex-col h-full">
            <div class="flex-1 p-6">
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white group-hover:text-primary transition-colors">
                ${term.title}
              </h3>
              ${(lang === 'ja' && term.eTitle) ? `
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${term.eTitle}</p>
              ` : ''}
              ${term.description ? `
                <p class="mt-3 text-base text-gray-600 dark:text-gray-300 line-clamp-3">
                  ${term.description}
                </p>
              ` : ''}
            </div>
          </a>
        `;
        return li;
      }

      // 0-9セクションの表示（行レベル）
      if (groupedTerms['0-9'] && groupedTerms['0-9'].length > 0) {
        const container = document.querySelector('[data-terms-container="0-9"]');
        const section = document.getElementById('0-9');
        if (container && section) {
          section.style.display = 'block';
          groupedTerms['0-9'].sort((a, b) => a.term.localeCompare(b.term, 'ja'));
          groupedTerms['0-9'].forEach(term => {
            container.appendChild(createTermCard(term));
          });
        }
      }
      
      // A-Zセクションは表示しない（個別文字A、B、C...で表示）

      // 詳細グループ（あ、い、う、A、B、Cなど）の表示
      Object.keys(detailedGroupedTerms).forEach(char => {
        detailedGroupedTerms[char].sort((a, b) => a.term.localeCompare(b.term, 'ja'));
        const container = document.querySelector(`[data-terms-container="${char}"]`);
        const section = document.getElementById(char);
        
        if (detailedGroupedTerms[char].length > 0 && container && section) {
          // セクションを表示
          section.style.display = 'block';
          detailedGroupedTerms[char].forEach(term => {
            container.appendChild(createTermCard(term));
          });
        } else if (detailedGroupedTerms[char].length > 0) {
          console.warn(`Section not found for ${char} (${detailedGroupedTerms[char].length} terms)`);
        }
      });

      // ナビゲーションのアクティブ状態を更新
      function updateNavigation() {
        const tabs = tabsContainer?.querySelectorAll('a') || [];
        tabs.forEach(tab => {
          const group = tab.dataset.group;
          tab.classList.remove(...allDynamicClasses);
          tab.removeAttribute('aria-current');

          if (groupedTerms[group] && groupedTerms[group].length > 0) {
            tab.classList.add(...defaultClasses);
          } else {
            tab.classList.add(...disabledClasses);
          }
        });
      }

      updateNavigation();

      function setActiveTab(groupToActivate) {
        if (!tabsContainer) return;

        const tabs = tabsContainer.querySelectorAll('a');
        tabs.forEach(tab => {
          const tabGroup = tab.dataset.group;
          tab.classList.remove(...allDynamicClasses);
          tab.removeAttribute('aria-current');

          const hasTerms = groupedTerms[tabGroup] && groupedTerms[tabGroup].length > 0;

          if (tabGroup === groupToActivate) {
            tab.classList.add(...activeClasses);
            tab.setAttribute('aria-current', 'page');
          } else if (hasTerms) {
            tab.classList.add(...defaultClasses);
          } else {
            tab.classList.add(...disabledClasses);
          }
        });

        if (select) {
          select.value = groupToActivate;
        }
      }

      function handleScroll() {
        if (window.innerWidth >= 1024) {
          if (window.scrollY > scrollThreshold) {
            alphabetNav?.classList.add(...borderClasses);
          } else {
            alphabetNav?.classList.remove(...borderClasses);
          }
        } else {
          alphabetNav?.classList.remove(...borderClasses);
        }
      }

      // 初期表示
      const firstGroupWithTerms = kanaGroups.find(group => groupedTerms[group].length > 0);
      if (firstGroupWithTerms) {
        setActiveTab(firstGroupWithTerms);
        // document.getElementById(firstGroupWithTerms)?.scrollIntoView({ behavior: "auto", block: "start" });
        
        // 初期表示時は強制的にトップにスクロール（ハッシュリンクによる自動スクロールを防ぐ）
        if (window.location.hash === '' && !window.location.search.includes('term=')) {
          window.scrollTo(0, 0);
          // 確実にトップに戻すため、少し遅延させて再度実行
          setTimeout(() => window.scrollTo(0, 0), 0);
          setTimeout(() => window.scrollTo(0, 0), 100);
        }
      }

      // サブナビゲーションの表示/非表示
      const mainNav = document.getElementById('mainNav');

      function closeAllSubnav() {
        document.querySelectorAll('#mainNav .sub-nav').forEach(nav => nav.classList.add('hidden'));
      }

      function toggleSubnav(group) {
        const wrapper = document.querySelector(`#mainNav [data-nav-group="${group}"]`);
        if (!wrapper) return;
        const subnav = wrapper.querySelector(`[data-subnav="${group}"]`);
        if (!subnav) return;
        const willOpen = subnav.classList.contains('hidden');
        closeAllSubnav();
        if (willOpen) subnav.classList.remove('hidden');
      }

      // hoverで確実に開閉（Tailwindのgroup-hoverに依存しない）
      let subnavCloseTimer = null;
      if (mainNav) {
        mainNav.querySelectorAll('[data-nav-group]').forEach(wrapper => {
          const group = wrapper.getAttribute('data-nav-group');
          const subnav = wrapper.querySelector(`[data-subnav="${group}"]`);
          if (!subnav) return;

          const cancelClose = () => {
            if (subnavCloseTimer) {
              clearTimeout(subnavCloseTimer);
              subnavCloseTimer = null;
            }
          };

          wrapper.addEventListener('mouseenter', () => {
            cancelClose();
            closeAllSubnav();
            subnav.classList.remove('hidden');
          });

          // メニューへ移動してクリックできるように、閉じるのは遅延
          wrapper.addEventListener('mouseleave', () => {
            cancelClose();
            subnavCloseTimer = setTimeout(() => {
              subnav.classList.add('hidden');
            }, 250);
          });

          subnav.addEventListener('mouseenter', cancelClose);
          subnav.addEventListener('mouseleave', () => {
            cancelClose();
            subnavCloseTimer = setTimeout(() => {
              subnav.classList.add('hidden');
            }, 250);
          });
        });
      }

      // ナビの外をクリックしたら閉じる
      document.addEventListener('click', function(e) {
        const inNav = e.target.closest('#mainNav');
        if (!inNav) {
          closeAllSubnav();
        }
      });

      // smooth scroll を有効化（アンカー遷移も含む）
      document.documentElement.style.scrollBehavior = 'smooth';
      applyScrollMargins();
      window.addEventListener('resize', applyScrollMargins);

      // サブグループクリック（あ、い、う、A、B、Cなど）
      document.addEventListener('click', function(e) {
        const subgroupLink = e.target.closest('a[data-subgroup]');
        if (subgroupLink) {
          e.stopPropagation();

           // 選択中背景色を更新
           document.querySelectorAll('a[data-subgroup]').forEach(a => {
             a.classList.remove('bg-indigo-100', 'dark:bg-indigo-900', 'text-primary');
           });
           subgroupLink.classList.add('bg-indigo-100', 'dark:bg-indigo-900', 'text-primary');

          const subgroup = subgroupLink.dataset.subgroup;
          const parentGroup = subgroupLink.dataset.parent;
          // サブナビを閉じる
          document.querySelectorAll('.sub-nav').forEach(nav => nav.classList.add('hidden'));
          if (parentGroup) {
            setActiveTab(parentGroup);
          }
          // 少し遅延させてからスクロール（DOM更新を待つ）
          setTimeout(() => {
            scrollToSection(subgroup);
          }, 50);
        }
      });

      // セクション内のサブナビリンク（あ行タイトル右側の「あいうえお」）
      document.addEventListener('click', function(e) {
        const sectionLink = e.target.closest('a[data-section-link]');
        if (sectionLink) {
          e.stopPropagation();

           // 選択中背景色を更新
           document.querySelectorAll('a[data-section-link]').forEach(a => {
             a.classList.remove('bg-indigo-100', 'dark:bg-indigo-900', 'text-primary');
           });
           sectionLink.classList.add('bg-indigo-100', 'dark:bg-indigo-900', 'text-primary');

          const char = sectionLink.dataset.sectionLink;
          const parentGroup = getKanaGroup(char);
          if (parentGroup) {
            setActiveTab(parentGroup);
          }
          scrollToSection(char);
        }
      });

      // hover色のフォールバック（CSS hover が効かない環境向け）
      document.addEventListener('mouseover', function(e) {
        const link = e.target.closest('a[data-subgroup], a[data-section-link]');
        if (!link) return;
        if (link.classList.contains('text-primary')) return;
        link.classList.add('bg-indigo-100');
      });
      document.addEventListener('mouseout', function(e) {
        const link = e.target.closest('a[data-subgroup], a[data-section-link]');
        if (!link) return;
        if (link.classList.contains('text-primary')) return;
        link.classList.remove('bg-indigo-100');
      });

      // モバイルセレクトボックス
      if (select) {
        select.addEventListener("change", function() {
          const selected = this.value;
          let targetId = selected;

          // 行グループは個別文字の先頭へ（行レベルdivを作らない設計のため）
          const groupToFirst = {
            'あ行': 'あ',
            'か行': 'か',
            'さ行': 'さ',
            'た行': 'た',
            'な行': 'な',
            'は行': 'は',
            'ま行': 'ま',
            'や行': 'や',
            'ら行': 'ら',
            'わ行': 'わ',
            'A-Z': 'A',
            '0-9': '0-9'
          };

          if (!document.getElementById(targetId) && groupToFirst[selected]) {
            targetId = groupToFirst[selected];
          }

          const section = document.getElementById(targetId);
          if (section) {
            const parentGroup = (selected === 'A-Z' || /^[A-Z]$/.test(selected))
              ? 'A-Z'
              : (selected === '0-9' || /^[0-9]$/.test(selected))
                ? '0-9'
                : (selected.endsWith('行') ? selected : getKanaGroup(selected));
            if (parentGroup) {
              setActiveTab(parentGroup);
            }
            scrollToSection(targetId);
          }
        });
      }

      // デスクトップタブクリック（行レベル：あ行、か行など）
      if (tabsContainer) {
        tabsContainer.addEventListener('click', function(e) {
          const targetTab = e.target.closest('a[data-group]');
          if (targetTab && !targetTab.classList.contains('pointer-events-none')) {
            e.preventDefault();
            const group = targetTab.dataset.group;

            // クリックでドロップダウンを確実に開く
            toggleSubnav(group);
            
            // 日本語の行（あ行、か行など）の場合、最初の文字セクションにスクロール
            const subGroups = {
              'あ行': 'あ', 'か行': 'か', 'さ行': 'さ', 'た行': 'た', 'な行': 'な',
              'は行': 'は', 'ま行': 'ま', 'や行': 'や', 'ら行': 'ら', 'わ行': 'わ'
            };
            
            const targetId = subGroups[group] || (group === 'A-Z' ? 'A' : group);
            scrollToSection(targetId);
            setActiveTab(group);
          }
        });
      }

      // スクロール監視
      const observerOptions = {
        root: null,
        rootMargin: "-20% 0px -80% 0px",
        threshold: 0
      };

      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const parent = entry.target.dataset.parent;
            setActiveTab(parent || entry.target.id);
          }
        });
      }, observerOptions);

      sections.forEach(section => {
        if (section.style.display !== 'none') {
          observer.observe(section);
        }
      });

      window.addEventListener('scroll', handleScroll);
      handleScroll();
    });
  </script>
  
{{ end }}

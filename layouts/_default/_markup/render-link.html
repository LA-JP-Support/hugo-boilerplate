{{/*
  External Link Handler
  =====================

  This template automatically handles external links with configurable attributes based on domain rules.

  [params.externalLinks]
    nofollow = false  # Global disable nofollow (default: true)

    [params.externalLinks.domainRules]
      "docs.google.com" = { target = "_self", rel = "" }
      "youtube.com" = { target = "_blank", rel = "nofollow noopener" }
      "support.qualityunit.com" = { target = "_self", rel = "noopener" }
*/}}

{{- $url := .Destination -}}
{{- $isExternal := hasPrefix $url "http://" | or (hasPrefix $url "https://") -}}

{{- $target := "" -}}
{{- $rel := "" -}}
{{- $linkTitle := .Title -}}
{{- $tooltip := "" -}}
{{- $isGlossaryLink := false -}}

{{- if $isExternal -}}
  {{- $parsedURL := urls.Parse site.BaseURL -}}
  {{- $currentDomain := $parsedURL.Host -}}

  {{- $domainRules := site.Params.externalLinks.domainRules | default dict -}}
  
  {{- $matchedRule := false -}}
  {{- range $domain, $rule := $domainRules -}}
    {{- if and (not $matchedRule) (strings.Contains $url $domain) -}}
      {{- $target = $rule.target -}}
      {{- $rel = $rule.rel -}}
      {{- $matchedRule = true -}}
    {{- end -}}
  {{- end -}}

  {{- if and (not $matchedRule) (strings.Contains $url $currentDomain) -}}
    {{- $target = "_blank" -}}
    {{- $rel = "noopener noreferrer" -}}
    {{- $matchedRule = true -}}
  {{- end -}}

  {{- if not $matchedRule -}}
    {{- $useNofollow := site.Params.externalLinks.nofollow | default true -}}
    {{- $target = "_blank" -}}
    {{- $rel = cond $useNofollow "nofollow noopener noreferrer" "noopener noreferrer" -}}
  {{- end -}}
{{- else -}}
  {{- /* For internal links, process with get-translated-url */ -}}
  {{- $url = partial "helpers/get-translated-url.html" (dict "url" $url "page" .Page) -}}

  {{- $candidate := false -}}
  {{- $parsedLink := urls.Parse $url -}}
  {{- $path := $parsedLink.Path -}}
  {{- if and $path (strings.Contains $path "/glossary/") -}}
    {{- $isGlossaryLink = true -}}
  {{- end -}}
  {{- if $path -}}
    {{- $trimmed := strings.TrimPrefix "/" $path | strings.TrimSuffix "/" -}}
    {{- $tmp := site.GetPage (printf "/%s" $trimmed) -}}
    {{- if $tmp -}}
      {{- $candidate = $tmp -}}
    {{- else -}}
      {{- $tmp = site.GetPage $trimmed -}}
      {{- if $tmp -}}
        {{- $candidate = $tmp -}}
      {{- else if ne $trimmed "" -}}
        {{- $tmp = site.GetPage (printf "%s/_index" $trimmed) -}}
        {{- if $tmp -}}
          {{- $candidate = $tmp -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- $relURL := $url | relURL -}}
  {{- $relURLNoSlash := strings.TrimSuffix "/" $relURL -}}
  {{- if not $candidate -}}
    {{- $matches := where site.RegularPages "RelPermalink" "==" $relURL -}}
    {{- if gt (len $matches) 0 -}}
      {{- $candidate = index $matches 0 -}}
    {{- end -}}
  {{- end -}}
  {{- if and (not $candidate) (ne $relURLNoSlash "") -}}
    {{- $matches := where site.RegularPages "RelPermalink" "==" (printf "%s/" $relURLNoSlash) -}}
    {{- if gt (len $matches) 0 -}}
      {{- $candidate = index $matches 0 -}}
    {{- end -}}
  {{- end -}}
  {{- if and (not $candidate) (ne $relURLNoSlash "") -}}
    {{- $matches := where site.RegularPages "RelPermalink" "==" $relURLNoSlash -}}
    {{- if gt (len $matches) 0 -}}
      {{- $candidate = index $matches 0 -}}
    {{- end -}}
  {{- end -}}

  {{- if not $isGlossaryLink -}}
    {{- with $candidate -}}
      {{- $tooltip = .Params.description | default "" -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if and (not $linkTitle) $tooltip -}}
  {{- $linkTitle = $tooltip -}}
{{- else if and $linkTitle $tooltip -}}
  {{- $linkTitle = printf "%s â€” %s" $linkTitle $tooltip -}}
{{- end -}}

<a href="{{ $url }}"
   {{- if $target }} target="{{ $target }}"{{ end }}
   {{- if $rel }} rel="{{ $rel }}"{{ end }}
   {{- with $linkTitle }} title="{{ . }}"{{ end -}}>
   {{- .Text -}}
</a>
